{
  "name": "TP - Step 4: Plan Document",
  "nodes": [
    {
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [0, 300],
      "webhookId": "tp-step-04-plan",
      "parameters": {
        "httpMethod": "POST",
        "path": "tp-step-04-plan",
        "responseMode": "responseNode",
        "options": {}
      },
      "typeVersion": 2
    },
    {
      "id": "prep",
      "name": "Prepare Plan Prompt",
      "type": "n8n-nodes-base.code",
      "position": [260, 300],
      "parameters": {
        "jsCode": "var body = $json.body || $json;\nvar reqs = body.requirements || {};\nvar reqType = reqs.procurement_type || 'неопределен';\nvar reqStr = JSON.stringify(reqs, null, 2);\nif (reqStr.length > 30000) reqStr = reqStr.substring(0, 30000);\nvar specStr = JSON.stringify(body.specData || {}, null, 2);\nif (specStr.length > 30000) specStr = specStr.substring(0, 30000);\nvar ciStr = JSON.stringify(body.contractorInfo || {}, null, 2);\n\nvar p = 'Ти си експерт по структуриране на технически предложения за обществени поръчки.\\n\\nПолучаваш:\\n\\n';\np += 'ТИП ПОРЪЧКА: ' + reqType + '\\n\\n';\np += 'ИЗВЛЕЧЕНИ ИЗИСКВАНИЯ:\\n' + reqStr + '\\n\\n';\np += 'АНАЛИЗ НА СПЕЦИФИКАЦИЯТА:\\n' + specStr + '\\n\\n';\np += 'ИНФОРМАЦИЯ ЗА ИЗПЪЛНИТЕЛЯ:\\n' + ciStr + '\\n\\n';\np += '## ЗАДАЧА\\nСъздай ДЕТАЙЛЕН план на техническото предложение.\\n\\n';\np += '⚠️ КРИТИЧНО: Всяка ПОДСЕКЦИЯ ще бъде написана от ОТДЕЛЕН AI агент в ОТДЕЛЕН API call. ';\np += 'Агентът вижда САМО своята подсекция от плана. Затова:\\n';\np += '- Указанията за всяка подсекция трябва да са САМОДОСТАТЪЧНИ\\n';\np += '- Всяка подсекция МАКСИМУМ 5 страници (~1875 думи)\\n';\np += '- Ако една тема изисква повече от 5 стр. — раздели я на 2+ подсекции\\n\\n';\np += '## ПРАВИЛА ЗА ПЛАНА\\n';\np += '1. Една ГЛАВНА секция за ВСЯКО изискване от документацията\\n';\np += '2. Всяка главна секция съдържа 3-8 подсекции\\n';\np += '3. Всяка ПОДСЕКЦИЯ е МАКСИМУМ 5 страници (ако темата е по-голяма — раздели на части)\\n';\np += '4. За всяка подсекция: конкретно какво да се напише, кои данни от спецификацията да се ползват\\n';\np += '5. Планирай таблици с точни колони (оборудване, персонал, графици, контрол на качество)\\n';\np += '6. Графици: таблици с Дейност | Седмица/Месец 1 | Седмица/Месец 2 | ...\\n';\np += '7. Реалистичен общ обем: 30-100 стр. в зависимост от сложността\\n';\np += '8. НЕ добавяй секции за несъществуващи изисквания\\n';\np += '9. Ако requirements е празен → базова структура (представяне, подход, график, организация)\\n';\np += '10. Ако specData полета са null → не създавай секции за тях\\n';\np += '11. Декларации (чл. 102 ЗОП и т.н.) = отделни подсекции с кратко съдържание, НЕ 10 стр.\\n\\n';\np += '## ФОРМАТ\\nВърни САМО валиден JSON (БЕЗ markdown блокове):\\n';\np += '{\\n  \"document_title\": \"ТЕХНИЧЕСКО ПРЕДЛОЖЕНИЕ за [точно наименование]\",\\n';\np += '  \"procurement_type\": \"строителство | услуги | доставки | проектиране\",\\n';\np += '  \"total_estimated_pages\": 60,\\n';\np += '  \"sections\": [\\n    {\\n';\np += '      \"id\": \"1\",\\n      \"title\": \"Заглавие от изискването\",\\n';\np += '      \"requirement_id\": \"оригинален ID\",\\n';\np += '      \"subsections\": [\\n        {\\n';\np += '          \"id\": \"1.1\",\\n          \"title\": \"Подзаглавие\",\\n';\np += '          \"estimated_pages\": 4,\\n';\np += '          \"content_guidance\": [\"Конкретно: опишете X със следните детайли...\", \"Включете таблица за Y с колони...\"],\\n';\np += '          \"spec_data_to_use\": [\"technical_parameters\", \"key_quantities\"],\\n';\np += '          \"tables_needed\": [{\"title\": \"Списък оборудване\", \"columns\": [\"Тип\", \"Марка/модел\", \"Брой\", \"Характеристики\"]}]\\n';\np += '        }\\n      ]\\n    }\\n  ],\\n';\np += '  \"appendices\": [{\"title\": \"\", \"description\": \"\"}]\\n}\\n\\n';\np += 'ПОМНИ: Всяка подсекция = ОТДЕЛЕН AI call. Максимум 5 стр. на подсекция!\\n';\np += 'САМО JSON, без друг текст.';\n\nreturn [{ json: { prompt: p } }];"
      },
      "typeVersion": 2
    },
    {
      "id": "llm",
      "name": "Plan Document",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [520, 300],
      "parameters": {
        "text": "={{ $json.prompt }}",
        "promptType": "define",
        "messages": {
          "messageValues": [
            {
              "type": "system",
              "message": "You create VERY detailed document plans for Bulgarian procurement proposals. CRITICAL CONSTRAINT: Each subsection will be written by a SEPARATE AI in a SEPARATE API call, so each subsection MUST be: (1) self-contained with complete guidance, (2) MAXIMUM 5 pages (~1875 words), (3) if a topic needs more than 5 pages, split into multiple subsections. Output ONLY valid JSON, no markdown. Language: Bulgarian."
            }
          ]
        }
      },
      "typeVersion": 1.4
    },
    {
      "id": "model",
      "name": "Claude Sonnet",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "position": [440, 520],
      "parameters": {
        "model": "anthropic/claude-sonnet-4",
        "options": {
          "maxTokens": 16000,
          "temperature": 0.2
        }
      },
      "credentials": {
        "openRouterApi": {
          "id": "UjrrZkDAIpdRXbb8",
          "name": "GP-Open_Router_Test"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "parse",
      "name": "Parse Plan",
      "type": "n8n-nodes-base.code",
      "position": [780, 300],
      "parameters": {
        "jsCode": "var raw = ($json.text || $json.response || '').trim();\nvar result;\n\ntry {\n  result = JSON.parse(raw);\n} catch (e) {\n  var m = raw.match(/```(?:json)?\\s*([\\s\\S]*?)```/);\n  var candidate = m ? m[1].trim() : raw;\n  try {\n    var s = candidate.indexOf('{');\n    var e2 = candidate.lastIndexOf('}');\n    var jsonStr = candidate.substring(s, e2 + 1);\n    jsonStr = jsonStr.replace(/,\\s*([\\]\\}])/g, '$1');\n    result = JSON.parse(jsonStr);\n  } catch (e3) {\n    result = { document_title: 'Parse error', sections: [], _raw: raw.substring(0, 2000) };\n  }\n}\n\nreturn [{ json: { documentPlan: result } }];"
      },
      "typeVersion": 2
    },
    {
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1040, 300],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}"
      },
      "typeVersion": 1.1
    }
  ],
  "connections": {
    "Webhook": { "main": [[{ "node": "Prepare Plan Prompt", "type": "main", "index": 0 }]] },
    "Prepare Plan Prompt": { "main": [[{ "node": "Plan Document", "type": "main", "index": 0 }]] },
    "Claude Sonnet": { "ai_languageModel": [[{ "node": "Plan Document", "type": "ai_languageModel", "index": 0 }]] },
    "Plan Document": { "main": [[{ "node": "Parse Plan", "type": "main", "index": 0 }]] },
    "Parse Plan": { "main": [[{ "node": "Respond", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" }
}
