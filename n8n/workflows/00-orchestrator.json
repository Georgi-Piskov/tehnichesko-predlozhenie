{
  "name": "TP - Orchestrator",
  "nodes": [
    {
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [0, 200],
      "webhookId": "tp-generate",
      "parameters": {
        "httpMethod": "POST",
        "path": "tp-generate",
        "responseMode": "responseNode",
        "options": {}
      },
      "typeVersion": 2
    },
    {
      "id": "init-job",
      "name": "Init Job",
      "type": "n8n-nodes-base.code",
      "position": [260, 200],
      "parameters": {
        "jsCode": "var body = $json.body || $json;\nvar jobId = 'tp_' + Date.now() + '_' + Math.random().toString(36).substring(2, 6);\nvar ci = {\n  name: body.contractorName || '',\n  eik: body.contractorEIK || '',\n  experience: body.contractorExperience || '',\n  certifications: body.contractorCertifications || '',\n  address: body.contractorAddress || ''\n};\nreturn [{\n  json: { jobId: jobId, contractorInfo: ci, timestamp: new Date().toISOString() },\n  binary: $binary\n}];"
      },
      "typeVersion": 2
    },
    {
      "id": "send-response",
      "name": "Send Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [520, 200],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ jobId: $json.jobId, status: 'accepted', message: 'Pipeline started' }) }}"
      },
      "typeVersion": 1.1
    },
    {
      "id": "start-pipeline",
      "name": "Start Pipeline",
      "type": "n8n-nodes-base.code",
      "position": [780, 200],
      "parameters": {
        "jsCode": "return [{ json: $json, binary: $binary }];"
      },
      "typeVersion": 2
    },
    {
      "id": "split-files",
      "name": "Split Binary Files",
      "type": "n8n-nodes-base.code",
      "position": [1040, 200],
      "parameters": {
        "jsCode": "var b = $binary || {};\nvar items = [];\nfor (var k of Object.keys(b)) {\n  items.push({ json: { sourceField: k, fileName: b[k].fileName || k, jobId: $json.jobId }, binary: { data: b[k] } });\n}\nif (items.length === 0) throw new Error('No files uploaded');\nreturn items;"
      },
      "typeVersion": 2
    },
    {
      "id": "extract-pdf",
      "name": "Extract from PDF",
      "type": "n8n-nodes-base.extractFromFile",
      "position": [1300, 200],
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "typeVersion": 1
    },
    {
      "id": "merge-texts",
      "name": "Merge Texts",
      "type": "n8n-nodes-base.code",
      "position": [0, 450],
      "parameters": {
        "jsCode": "var items = $input.all();\nvar docText = '', specText = '';\nfor (var item of items) {\n  var text = item.json.text || item.json.data || '';\n  var sf = item.json.sourceField || '';\n  if (sf === 'documentation' || sf.toLowerCase().indexOf('doc') >= 0) docText += text;\n  else specText += text;\n}\nvar fullText = (docText + '\\n\\n---\\n\\n' + specText).trim();\nreturn [{ json: { documentationText: docText, specificationText: specText, fullText: fullText, totalCharacters: fullText.length, documentCount: items.length } }];"
      },
      "typeVersion": 2
    },
    {
      "id": "after-extract",
      "name": "After Extract",
      "type": "n8n-nodes-base.code",
      "position": [260, 450],
      "parameters": {
        "jsCode": "return [{ json: $json }];"
      },
      "typeVersion": 2
    },
    {
      "id": "extract-requirements",
      "name": "Extract Requirements",
      "type": "n8n-nodes-base.httpRequest",
      "position": [520, 450],
      "parameters": {
        "method": "POST",
        "url": "https://n8n.simeontsvetanovn8nworkflows.site/webhook/tp-step-02-requirements",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": { "timeout": 180000 }
      },
      "typeVersion": 4.2
    },
    {
      "id": "after-requirements",
      "name": "After Requirements",
      "type": "n8n-nodes-base.code",
      "position": [780, 450],
      "parameters": {
        "jsCode": "var mt = $('Merge Texts').first().json;\nreturn [{ json: { documentationText: mt.documentationText || '', specificationText: mt.specificationText || '', fullText: mt.fullText || '' } }];"
      },
      "typeVersion": 2
    },
    {
      "id": "analyze-spec",
      "name": "Analyze Spec",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1040, 450],
      "parameters": {
        "method": "POST",
        "url": "https://n8n.simeontsvetanovn8nworkflows.site/webhook/tp-step-03-analyze",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": { "timeout": 180000 }
      },
      "typeVersion": 4.2
    },
    {
      "id": "after-spec",
      "name": "After Spec Analysis",
      "type": "n8n-nodes-base.code",
      "position": [1300, 450],
      "parameters": {
        "jsCode": "return [{ json: {\n  requirements: $('Extract Requirements').first().json.requirements || $('Extract Requirements').first().json,\n  specData: $json.specData || $json,\n  contractorInfo: $('Init Job').first().json.contractorInfo\n} }];"
      },
      "typeVersion": 2
    },
    {
      "id": "plan-document",
      "name": "Plan Document",
      "type": "n8n-nodes-base.httpRequest",
      "position": [0, 700],
      "parameters": {
        "method": "POST",
        "url": "https://n8n.simeontsvetanovn8nworkflows.site/webhook/tp-step-04-plan",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": { "timeout": 180000 }
      },
      "typeVersion": 4.2
    },
    {
      "id": "flatten-chunks",
      "name": "Flatten Chunks",
      "type": "n8n-nodes-base.code",
      "position": [260, 700],
      "parameters": {
        "jsCode": "var plan = $json.documentPlan;\nvar reqs = $('Extract Requirements').first().json.requirements || $('Extract Requirements').first().json;\nvar spec = $('Analyze Spec').first().json.specData || $('Analyze Spec').first().json;\nvar ci = $('Init Job').first().json.contractorInfo || {};\nvar pt = (reqs && reqs.procurement_type) || 'unknown';\nvar sections = (plan && plan.sections) || [];\nif (sections.length === 0) throw new Error('Plan has no sections');\n\nvar sd = $getWorkflowStaticData('global');\nsd.fullDoc = '# ' + (plan.document_title || 'ТЕХНИЧЕСКО ПРЕДЛОЖЕНИЕ') + '\\n\\n';\nsd.lastParent = '';\nsd.results = [];\n\nvar chunks = [];\nfor (var s = 0; s < sections.length; s++) {\n  var sec = sections[s];\n  var subs = sec.subsections || [];\n  if (subs.length === 0) {\n    chunks.push({\n      id: sec.id, title: sec.title, parentId: null, parentTitle: null,\n      estimated_pages: sec.estimated_pages || 5,\n      content_guidance: sec.content_guidance || [],\n      spec_data_to_use: sec.spec_data_to_use || [],\n      tables_needed: sec.tables_needed || [],\n      requirement_id: sec.requirement_id\n    });\n  } else {\n    for (var j = 0; j < subs.length; j++) {\n      var sub = subs[j];\n      chunks.push({\n        id: sub.id, title: sub.title,\n        parentId: sec.id, parentTitle: sec.title,\n        estimated_pages: sub.estimated_pages || 4,\n        content_guidance: sub.content_guidance || [],\n        spec_data_to_use: sub.spec_data_to_use || [],\n        tables_needed: sub.tables_needed || [],\n        requirement_id: sub.requirement_id || sec.requirement_id\n      });\n    }\n  }\n}\n\nvar items = [];\nfor (var i = 0; i < chunks.length; i++) {\n  items.push({\n    json: {\n      chunk: chunks[i],\n      chunkIndex: i,\n      totalChunks: chunks.length,\n      requirements: reqs,\n      specData: spec,\n      contractorInfo: ci,\n      procurementType: pt\n    }\n  });\n}\nreturn items;"
      },
      "typeVersion": 2
    },
    {
      "id": "loop-over-items",
      "name": "Loop Over Items",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [520, 700],
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "typeVersion": 3
    },
    {
      "id": "prep-write",
      "name": "Prep Write",
      "type": "n8n-nodes-base.code",
      "position": [720, 920],
      "parameters": {
        "jsCode": "var sd = $getWorkflowStaticData('global');\nvar prevCtx = sd.fullDoc || '';\nif (prevCtx.length > 2000) prevCtx = prevCtx.substring(prevCtx.length - 2000);\n\nreturn [{ json: {\n  section: $json.chunk,\n  requirements: $json.requirements,\n  specData: $json.specData,\n  contractorInfo: $json.contractorInfo,\n  previousContext: prevCtx,\n  feedback: '',\n  procurementType: $json.procurementType,\n  sectionIndex: $json.chunkIndex,\n  totalSections: $json.totalChunks\n} }];"
      },
      "typeVersion": 2
    },
    {
      "id": "write-section",
      "name": "Write Section",
      "type": "n8n-nodes-base.httpRequest",
      "position": [980, 920],
      "parameters": {
        "method": "POST",
        "url": "https://n8n.simeontsvetanovn8nworkflows.site/webhook/tp-write-section",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": { "timeout": 180000 }
      },
      "typeVersion": 4.2
    },
    {
      "id": "prep-validate",
      "name": "Prep Validate",
      "type": "n8n-nodes-base.code",
      "position": [1240, 920],
      "parameters": {
        "jsCode": "var pw = $('Prep Write').first().json;\nreturn [{ json: {\n  sectionText: $json.sectionText || $json.text || '',\n  section: pw.section,\n  requirements: pw.requirements,\n  procurementType: pw.procurementType\n} }];"
      },
      "typeVersion": 2
    },
    {
      "id": "validate-section",
      "name": "Validate Section",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1500, 920],
      "parameters": {
        "method": "POST",
        "url": "https://n8n.simeontsvetanovn8nworkflows.site/webhook/tp-validate-section",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": { "timeout": 120000 }
      },
      "typeVersion": 4.2
    },
    {
      "id": "check-validation",
      "name": "Check Validation",
      "type": "n8n-nodes-base.if",
      "position": [1760, 920],
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            {
              "id": "cond1",
              "leftValue": "={{ $json.passed }}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "equals", "singleValue": true }
            }
          ],
          "combinator": "and"
        }
      },
      "typeVersion": 2.2
    },
    {
      "id": "accumulate-section",
      "name": "Accumulate Section",
      "type": "n8n-nodes-base.code",
      "position": [2020, 820],
      "parameters": {
        "jsCode": "var sd = $getWorkflowStaticData('global');\nvar pw = $('Prep Write').first().json;\nvar writeRes = $('Write Section').first().json;\n\nvar chunk = pw.section;\nvar secText = writeRes.sectionText || writeRes.text || '';\n\nif (chunk.parentTitle && chunk.parentTitle !== sd.lastParent) {\n  sd.fullDoc += '## ' + (chunk.parentId || '') + '. ' + chunk.parentTitle + '\\n\\n';\n  sd.lastParent = chunk.parentTitle;\n}\n\nsd.fullDoc += secText + '\\n\\n';\nsd.results.push({\n  id: chunk.id,\n  title: chunk.title,\n  wordCount: secText.trim().split(/\\s+/).length,\n  passed: true,\n  score: $('Validate Section').first().json.score || 100,\n  attempts: 1\n});\n\nreturn [{ json: { ok: true } }];"
      },
      "typeVersion": 2
    },
    {
      "id": "prep-rewrite",
      "name": "Prep Rewrite",
      "type": "n8n-nodes-base.code",
      "position": [2020, 1040],
      "parameters": {
        "jsCode": "var sd = $getWorkflowStaticData('global');\nvar pw = $('Prep Write').first().json;\nvar valResult = $json;\nvar prevCtx = sd.fullDoc || '';\nif (prevCtx.length > 2000) prevCtx = prevCtx.substring(prevCtx.length - 2000);\n\nvar fb = valResult.feedback || '';\nif (valResult.issues && Array.isArray(valResult.issues)) {\n  fb += '\\n\\nКонкретни проблеми:\\n';\n  for (var i = 0; i < valResult.issues.length; i++) {\n    fb += '- ' + valResult.issues[i] + '\\n';\n  }\n}\n\nreturn [{ json: {\n  section: pw.section,\n  requirements: pw.requirements,\n  specData: pw.specData,\n  contractorInfo: pw.contractorInfo,\n  previousContext: prevCtx,\n  feedback: fb,\n  procurementType: pw.procurementType,\n  sectionIndex: pw.sectionIndex,\n  totalSections: pw.totalSections\n} }];"
      },
      "typeVersion": 2
    },
    {
      "id": "rewrite-section",
      "name": "Rewrite Section",
      "type": "n8n-nodes-base.httpRequest",
      "position": [2280, 1040],
      "parameters": {
        "method": "POST",
        "url": "https://n8n.simeontsvetanovn8nworkflows.site/webhook/tp-write-section",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": { "timeout": 180000 }
      },
      "typeVersion": 4.2
    },
    {
      "id": "accumulate-retry",
      "name": "Accumulate Retry",
      "type": "n8n-nodes-base.code",
      "position": [2540, 1040],
      "parameters": {
        "jsCode": "var sd = $getWorkflowStaticData('global');\nvar pw = $('Prep Write').first().json;\nvar rewriteRes = $json;\n\nvar chunk = pw.section;\nvar secText = rewriteRes.sectionText || rewriteRes.text || '';\n\nif (chunk.parentTitle && chunk.parentTitle !== sd.lastParent) {\n  sd.fullDoc += '## ' + (chunk.parentId || '') + '. ' + chunk.parentTitle + '\\n\\n';\n  sd.lastParent = chunk.parentTitle;\n}\n\nsd.fullDoc += secText + '\\n\\n';\nsd.results.push({\n  id: chunk.id,\n  title: chunk.title,\n  wordCount: secText.trim().split(/\\s+/).length,\n  passed: false,\n  score: $('Validate Section').first().json.score || 0,\n  attempts: 2\n});\n\nreturn [{ json: { ok: true } }];"
      },
      "typeVersion": 2
    },
    {
      "id": "assemble-document",
      "name": "Assemble Document",
      "type": "n8n-nodes-base.code",
      "position": [780, 700],
      "parameters": {
        "jsCode": "var sd = $getWorkflowStaticData('global');\nvar fullDoc = sd.fullDoc || '';\nvar results = sd.results || [];\nvar totalWC = fullDoc.trim().split(/\\s+/).length;\n\nsd.fullDoc = '';\nsd.lastParent = '';\nsd.results = [];\n\nreturn [{ json: {\n  fullDocument: fullDoc,\n  sectionResults: results,\n  totalWordCount: totalWC,\n  estimatedPages: Math.round(totalWC / 375)\n} }];"
      },
      "typeVersion": 2
    },
    {
      "id": "prep-finalize",
      "name": "Prep Finalize",
      "type": "n8n-nodes-base.code",
      "position": [1040, 700],
      "parameters": {
        "jsCode": "return [{ json: { draftText: $json.fullDocument || '' } }];"
      },
      "typeVersion": 2
    },
    {
      "id": "finalize-document",
      "name": "Finalize Document",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1300, 700],
      "parameters": {
        "method": "POST",
        "url": "https://n8n.simeontsvetanovn8nworkflows.site/webhook/tp-step-07-finalize",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": { "timeout": 600000 }
      },
      "typeVersion": 4.2
    },
    {
      "id": "pipeline-complete",
      "name": "Pipeline Complete",
      "type": "n8n-nodes-base.code",
      "position": [1560, 700],
      "parameters": {
        "jsCode": "var finalText = $json.finalText || $json.draftText || '';\nreturn [{ json: { success: true, finalDocument: finalText } }];"
      },
      "typeVersion": 2
    }
  ],
  "connections": {
    "Webhook": { "main": [[{ "node": "Init Job", "type": "main", "index": 0 }]] },
    "Init Job": { "main": [[{ "node": "Send Response", "type": "main", "index": 0 }]] },
    "Send Response": { "main": [[{ "node": "Start Pipeline", "type": "main", "index": 0 }]] },
    "Start Pipeline": { "main": [[{ "node": "Split Binary Files", "type": "main", "index": 0 }]] },
    "Split Binary Files": { "main": [[{ "node": "Extract from PDF", "type": "main", "index": 0 }]] },
    "Extract from PDF": { "main": [[{ "node": "Merge Texts", "type": "main", "index": 0 }]] },
    "Merge Texts": { "main": [[{ "node": "After Extract", "type": "main", "index": 0 }]] },
    "After Extract": { "main": [[{ "node": "Extract Requirements", "type": "main", "index": 0 }]] },
    "Extract Requirements": { "main": [[{ "node": "After Requirements", "type": "main", "index": 0 }]] },
    "After Requirements": { "main": [[{ "node": "Analyze Spec", "type": "main", "index": 0 }]] },
    "Analyze Spec": { "main": [[{ "node": "After Spec Analysis", "type": "main", "index": 0 }]] },
    "After Spec Analysis": { "main": [[{ "node": "Plan Document", "type": "main", "index": 0 }]] },
    "Plan Document": { "main": [[{ "node": "Flatten Chunks", "type": "main", "index": 0 }]] },
    "Flatten Chunks": { "main": [[{ "node": "Loop Over Items", "type": "main", "index": 0 }]] },
    "Loop Over Items": {
      "main": [
        [{ "node": "Assemble Document", "type": "main", "index": 0 }],
        [{ "node": "Prep Write", "type": "main", "index": 0 }]
      ]
    },
    "Prep Write": { "main": [[{ "node": "Write Section", "type": "main", "index": 0 }]] },
    "Write Section": { "main": [[{ "node": "Prep Validate", "type": "main", "index": 0 }]] },
    "Prep Validate": { "main": [[{ "node": "Validate Section", "type": "main", "index": 0 }]] },
    "Validate Section": { "main": [[{ "node": "Check Validation", "type": "main", "index": 0 }]] },
    "Check Validation": {
      "main": [
        [{ "node": "Accumulate Section", "type": "main", "index": 0 }],
        [{ "node": "Prep Rewrite", "type": "main", "index": 0 }]
      ]
    },
    "Accumulate Section": { "main": [[{ "node": "Loop Over Items", "type": "main", "index": 0 }]] },
    "Prep Rewrite": { "main": [[{ "node": "Rewrite Section", "type": "main", "index": 0 }]] },
    "Rewrite Section": { "main": [[{ "node": "Accumulate Retry", "type": "main", "index": 0 }]] },
    "Accumulate Retry": { "main": [[{ "node": "Loop Over Items", "type": "main", "index": 0 }]] },
    "Assemble Document": { "main": [[{ "node": "Prep Finalize", "type": "main", "index": 0 }]] },
    "Prep Finalize": { "main": [[{ "node": "Finalize Document", "type": "main", "index": 0 }]] },
    "Finalize Document": { "main": [[{ "node": "Pipeline Complete", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" }
}
